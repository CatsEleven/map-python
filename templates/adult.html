<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>大人向け交通安全マップ</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      video {
        width: 240px;
        height: auto;
      }
    </style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const logs = JSON.parse('{{ logs | tojson | safe }}');

  // 日本時間表示フォーマット関数
  function formatJST(utcString) {
    const date = new Date(utcString);       
    const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);  

    const Y = jst.getFullYear();
    const M = String(jst.getMonth() + 1).padStart(2, '0');
    const D = String(jst.getDate()).padStart(2, '0');
    const h = String(jst.getHours()).padStart(2, '0');
    const m = String(jst.getMinutes()).padStart(2, '0');

    return `${Y}/${M}/${D} ${h}:${m}`;
  }

  const map = L.map("map").setView([35.568224057746825, 139.3988371730611], 15);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  logs.forEach(item => {
    const lat = item.latitude;
    const lon = item.longitude;

    const jstTime = formatJST(item.created_at);
    const speed = Number(item.speed);
    const speedText = `${speed.toFixed(1)} km/h`;

    const popupHtml = `
      <div>
        <p>${jstTime}</p>
        <p>AEB作動時の車速: ${speedText}</p>
        <video controls width="300" preload="metadata">
        <source src="${item.imageUrl}" type="video/mp4">
        </video>
      </div>
    `;

    L.marker([lat, lon]).addTo(map)
      .bindPopup(popupHtml);
  });
</script>

</body>
</html>
