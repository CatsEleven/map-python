<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>OSM 道路のみマップ + スーパー表示 + 信号機</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background-color: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .poi-label .label-text {
            background: white;
            border: 2px solid #333;
            border-radius: 6px;
            padding: 3px 6px;
            font-size: 18px;
            font-weight: bold;
            color: #222;
            white-space: nowrap;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ---- マップ中心 ----
        const centerLat = 35.568224057746825;
        const centerLon = 139.3988371730611;

        const map = L.map("map").setView([centerLat, centerLon], 16);

        // ---- 完全白の背景 ----
        L.tileLayer(
            "https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png",
            {
                maxZoom: 19,
                attribution: "<a href='https://maps.gsi.go.jp/development/'>地理院タイル</a>"
            }
        ).addTo(map);

        // ----------------------------
        // スーパーアイコン
        // ----------------------------
        const supermarketIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='super.svg') }}",
            iconSize: [100, 100],
            iconAnchor: [50, 50]
        });

        const convenienceIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='convini.svg') }}",
            iconSize: [80, 80],
            iconAnchor: [40, 40]
        });

        const stationIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='station.svg') }}",
            iconSize: [90, 90],
            iconAnchor: [45, 45]
        });

        const supermarketQuery = `
  [out:json][timeout:25];
  (
    node["shop"="supermarket"](around:1500, ${centerLat}, ${centerLon});
    way["shop"="supermarket"](around:1500, ${centerLat}, ${centerLon});
    relation["shop"="supermarket"](around:1500, ${centerLat}, ${centerLon});
  );
  out center;
`;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: supermarketQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const lat = el.lat || el.center?.lat;
                    const lon = el.lon || el.center?.lon;
                    if (!lat || !lon) return;

                    const name = el.tags?.name || "スーパー";

                    L.marker([lat, lon], { icon: supermarketIcon }).addTo(map);

                    const label = L.divIcon({
                        className: "poi-label",
                        html: `<div class="label-text">${name}</div>`,
                        iconSize: [100, 30],
                        iconAnchor: [50, 70]
                    });
                    L.marker([lat, lon], { icon: label }).addTo(map);
                });
            })
            .catch(err => console.error(err));


        // ----------------------------
        // 駅表示
        // ----------------------------
        const stationQuery = `
  [out:json][timeout:25];
  (
    node["railway"="station"](around:2000, ${centerLat}, ${centerLon});
    way["railway"="station"](around:2000, ${centerLat}, ${centerLon});
    relation["railway"="station"](around:2000, ${centerLat}, ${centerLon});
  );
  out center;
`;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: stationQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const lat = el.lat || el.center?.lat;
                    const lon = el.lon || el.center?.lon;
                    if (!lat || !lon) return;

                    const name = el.tags?.name || "駅";

                    L.marker([lat, lon], { icon: stationIcon }).addTo(map);

                    const label = L.divIcon({
                        className: "poi-label",
                        html: `<div class="label-text">${name}</div>`,
                        iconSize: [120, 34],
                        iconAnchor: [60, 80]
                    });
                    L.marker([lat, lon], { icon: label }).addTo(map);
                });
            })
            .catch(err => console.error(err));


        // ----------------------------
        // コンビニ表示
        // ----------------------------
        const convenienceQuery = `
  [out:json][timeout:25];
  (
    node["shop"="convenience"](around:1500, ${centerLat}, ${centerLon});
    way["shop"="convenience"](around:1500, ${centerLat}, ${centerLon});
    relation["shop"="convenience"](around:1500, ${centerLat}, ${centerLon});
  );
  out center;
`;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: convenienceQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const lat = el.lat || el.center?.lat;
                    const lon = el.lon || el.center?.lon;
                    if (!lat || !lon) return;

                    const name = el.tags?.name || "コンビニ";

                    L.marker([lat, lon], { icon: convenienceIcon }).addTo(map);

                    const label = L.divIcon({
                        className: "poi-label",
                        html: `<div class="label-text">${name}</div>`,
                        iconSize: [100, 30],
                        iconAnchor: [50, 70]
                    });
                    L.marker([lat, lon], { icon: label }).addTo(map);
                });
            })
            .catch(err => console.error(err));


        // ----------------------------
        // 歩行者用信号機の表示
        // ----------------------------
        const signalIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='signal-person.png') }}",
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        const signalQuery = `
[out:json][timeout:25];
(
    node["highway"="traffic_signals"](around:1500, ${centerLat}, ${centerLon});
    way["highway"="traffic_signals"](around:1500, ${centerLat}, ${centerLon});
    relation["highway"="traffic_signals"](around:1500, ${centerLat}, ${centerLon});
);
out center;
`;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: signalQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const lat = el.lat || el.center?.lat;
                    const lon = el.lon || el.center?.lon;
                    if (!lat || !lon) return;

                    L.marker([lat, lon], { icon: signalIcon }).addTo(map);
                });
            })
            .catch(err => console.error(err));


        // ----------------------------
        // OSM 道路表示
        // ----------------------------
        const roadQuery = `
      [out:json][timeout:25];
      (
        way["highway"~"^(primary|secondary|tertiary|unclassified|residential|trunk|motorway)$"]
          (around:2000, ${centerLat}, ${centerLon});
      );
      out geom;
    `;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: roadQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    if (!el.geometry) return;

                    const latlngs = el.geometry.map(g => [g.lat, g.lon]);

                    let w = 4;
                    if (el.tags.highway === "primary") w = 15;
                    else if (el.tags.highway === "secondary") w = 12;
                    else if (el.tags.highway === "tertiary") w = 10;
                    else if (el.tags.highway === "residential") w = 7;

                    L.polyline(latlngs, {
                        color: "#222",
                        weight: w,
                        opacity: 1
                    }).addTo(map);
                });
            })
            .catch(err => console.error(err));

    </script>

</body>

</html>
