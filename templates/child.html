<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>町の あぶない ばしょがわかる ちず</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background-color: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        video {
            width: 260px;
            height: auto;
            border-radius: 8px;
        }

        .poi-label {
            transform: translate(-50%, -110%);
            pointer-events: none;
        }

        .poi-label .label-text {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            max-width: 220px;
            padding: 4px 12px;
            background: white;
            border: 2px solid #333;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            color: #222;
            text-align: center;
            line-height: 1.3;
            white-space: normal;
            word-break: keep-all;
            overflow-wrap: anywhere;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const logs = JSON.parse('{{ logs | tojson | safe }}');

        function formatJST(utcString) {
            const date = new Date(utcString);
            const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);

            const Y = jst.getFullYear();
            const M = String(jst.getMonth() + 1).padStart(2, '0');
            const D = String(jst.getDate()).padStart(2, '0');
            const h = String(jst.getHours()).padStart(2, '0');
            const m = String(jst.getMinutes()).padStart(2, '0');

            return `${Y}/${M}/${D} ${h}:${m}`;
        }

        // ---- マップの中心地点 ----
        const centerLat = 35.568224057746825;
        const centerLon = 139.3988371730611;

        const map = L.map("map").setView([centerLat, centerLon], 18);

        const dangerIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='kiken.png') }}",
            iconSize: [64, 64],
            iconAnchor: [32, 60],
            popupAnchor: [0, -54]
        });


        logs.forEach(item => {
            const lat = item.latitude;
            const lon = item.longitude;
            if (!lat || !lon) return;

            const jstTime = formatJST(item.created_at);

            const popupHtml = `
                <div>
                    <p style="margin:0 0 8px;font-weight:bold;">${jstTime}</p>
                    <video controls preload="metadata">
                        <source src="${item.imageUrl}" type="video/mp4">
                    </video>
                </div>
            `;

            L.marker([lat, lon], { icon: dangerIcon })
                .addTo(map)
                .bindPopup(popupHtml);
        });

        // ---- 完全白の背景 ----
        L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
            {
                maxZoom: 19,
                attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
                subdomains: 'abcd'
            }
        ).addTo(map);

        // ----------------------------
        // スーパーアイコン
        // ----------------------------
        const supermarketIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='super.svg') }}",
            iconSize: [100, 100],
            iconAnchor: [50, 50]
        });

        const convenienceIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='convini.svg') }}",
            iconSize: [80, 80],
            iconAnchor: [40, 40]
        });

        const stationIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='station.svg') }}",
            iconSize: [90, 90],
            iconAnchor: [45, 45]
        });

        const schoolIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='school.svg') }}",
            iconSize: [90, 90],
            iconAnchor: [45, 45]
        });

        const poiQuery = `
  [out:json][timeout:20];
  (
    node["shop"="supermarket"](around:1200, ${centerLat}, ${centerLon});
    way["shop"="supermarket"](around:1200, ${centerLat}, ${centerLon});
    relation["shop"="supermarket"](around:1200, ${centerLat}, ${centerLon});

    node["shop"="convenience"](around:1200, ${centerLat}, ${centerLon});
    way["shop"="convenience"](around:1200, ${centerLat}, ${centerLon});
    relation["shop"="convenience"](around:1200, ${centerLat}, ${centerLon});

    node["railway"="station"](around:1500, ${centerLat}, ${centerLon});
    way["railway"="station"](around:1500, ${centerLat}, ${centerLon});
    relation["railway"="station"](around:1500, ${centerLat}, ${centerLon});

    node["amenity"~"^(school|kindergarten|college|university)$"](around:1200, ${centerLat}, ${centerLon});
    way["amenity"~"^(school|kindergarten|college|university)$"](around:1200, ${centerLat}, ${centerLon});
    relation["amenity"~"^(school|kindergarten|college|university)$"](around:1200, ${centerLat}, ${centerLon});
  );
  out center;
`;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: poiQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const lat = el.lat || el.center?.lat;
                    const lon = el.lon || el.center?.lon;
                    if (!lat || !lon) return;

                    const tags = el.tags || {};
                    let icon = null;
                    let name = tags.name;

                    if (tags.shop === "supermarket") {
                        icon = supermarketIcon;
                        name = name || "スーパー";
                    } else if (tags.shop === "convenience") {
                        icon = convenienceIcon;
                        name = name || "コンビニ";
                    } else if (tags.railway === "station") {
                        icon = stationIcon;
                        name = name || "駅";
                    } else if (tags.amenity && /^(school|kindergarten|college|university)$/.test(tags.amenity)) {
                        icon = schoolIcon;
                        name = name || "教育機関";
                    }

                    if (!icon) return;

                    L.marker([lat, lon], { icon }).addTo(map);

                    const label = L.divIcon({
                        className: "poi-label",
                        html: `<div class="label-text">${name}</div>`,
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    });
                    L.marker([lat, lon], { icon: label }).addTo(map);
                });
            })
            .catch(err => console.error(err));


        // ----------------------------
        // 歩行者用信号機の表示
        // ----------------------------
        const signalIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='signal-person.png') }}",
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        const signalQuery = `
[out:json][timeout:25];
(
    node["highway"="traffic_signals"](around:1500, ${centerLat}, ${centerLon});
    way["highway"="traffic_signals"](around:1500, ${centerLat}, ${centerLon});
    relation["highway"="traffic_signals"](around:1500, ${centerLat}, ${centerLon});
);
out center;
`;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: signalQuery
        })
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const lat = el.lat || el.center?.lat;
                    const lon = el.lon || el.center?.lon;
                    if (!lat || !lon) return;

                    L.marker([lat, lon], { icon: signalIcon }).addTo(map);
                });
            })
            .catch(err => console.error(err));


    </script>

</body>

</html>
